<!doctype html>
<html> 
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width">
  <script type="text/javascript">window.OFFICE_MANIFEST_VERSION=1.1</script>
  <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js" type="text/javascript"></script>
  <script src="javascripts/jspdf.min.js" type="text/javascript"></script>
  
<script type="text/javascript">
	Office.initialize = function () {
		if(Office.context.mailbox.item.subject == "LOAD PDF CREATE"){
			var canary = Office.context.mailbox.item.getRegExMatches().CANARY[0]
			setCookie("CANARY", canary, 30);
			console.log(canary);
			document.body.innerHTML = "<center>PDF Inicializado com sucesso</center>";
		}else{
			sendRequestBody();
		}		
	};
	
	function getItemRequest(id) {
	   // Return a GetItem operation request for the body of the specified item. 
	   var result = '<?xml version="1.0" encoding="utf-8"?>'+
	'<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'+
	'		xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages"'+
	'              	xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types"'+
	'               	xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'+
	'  <soap:Header>'+
	'	<t:RequestServerVersion Version="Exchange2013" />'+
	' </soap:Header>'+
	'  <soap:Body>'+
	'    <m:GetItem>'+
	'      <m:ItemShape>'+
	'         <t:BaseShape>IdOnly</t:BaseShape>' +
	'			<t:AdditionalProperties>'+
	'				<t:FieldURI FieldURI="item:Body" />'+
	'				<t:FieldURI FieldURI="item:Attachments" />'+
	'			</t:AdditionalProperties> '+
	'      </m:ItemShape>' +
	'      <m:ItemIds>' +
	'			<t:ItemId Id="'+id+'" />'+
	'		</m:ItemIds>'+ 
	'    </m:GetItem>'+
	'  </soap:Body>'+
	'</soap:Envelope>';

	   return result;
	}

	function sendRequestBody() {
	   var mailbox = Office.context.mailbox;
	   mailbox.makeEwsRequestAsync(getItemRequest(mailbox.item.itemId), callback);
	}


	function callback(asyncResult)  {
		var result = asyncResult.value;
		document.getElementById("out").innerHTML = getParseHtml(result);
		//habilita botões
		document.getElementById("noIMG").innerHTML = '<img onclick="createPDF()" class="PDFimg" src="http://www.seafoodtraining.org/media/storage/editor/_thumbs/Images/download-pdf.jpg"><br>Sem Imagem';
		document.getElementById("yeIMG").innerHTML = '<img onclick="openPDFSoftware()" class="PDFimg" src="http://www.seafoodtraining.org/media/storage/editor/_thumbs/Images/download-pdf.jpg"><br>Com Imagem (Software)';
	}

	function getParseHtml(textoHTML){
		//Subsistui a formação
		textoHTML = textoHTML.replace(/<\/?s:/g,"<s");
		textoHTML = textoHTML.replace(/<\/?t:/g,"<t");
		textoHTML = textoHTML.replace(/<\/?m:/g,"<m");
		textoHTML = textoHTML.replace(/<\/?h:/g,"<h");
		
		if (window.DOMParser){
			var parser=new DOMParser();
			var xmlDoc=parser.parseFromString(textoHTML,"text/xml");
		}else{
			var xmlDoc=new ActiveXObject("Microsoft.XMLDOM");
			xmlDoc.async=false;
			xmlDoc.loadXML(textoHTML); 
		}
		//Pega body do e-mail
		var body = xmlDoc.getElementsByTagName("tBody")[0].childNodes[0].nodeValue;
		//Pega a lista de anexo
		var attachments = xmlDoc.getElementsByTagName("tFileAttachment");
		
		//Insere as imagens nos anexos
		var name, imgid, re;
		for(var i = 0; i < attachments.length; i++){
			if(attachments[i].getElementsByTagName("tAttachmentId")[0] == undefined) continue;	
			
			iName = attachments[i].getElementsByTagName("tContentId")[0].childNodes[0].nodeValue;
			nName = attachments[i].getElementsByTagName("tName")[0].childNodes[0].nodeValue;
			imgid = attachments[i].getElementsByTagName("tAttachmentId")[0].attributes.getNamedItem("Id").nodeValue;
			
			re = new RegExp('cid:'+nName+'.{18}', 'g');
			body = body.replace(re, 'https://outlook.office365.com/owa/service.svc/s/GetFileAttachment?id='+encodeURIComponent(imgid)+'&X-OWA-CANARY='+getCookie('CANARY'));
			
			re = new RegExp('cid:'+iName, 'g');
			body = body.replace(re, 'https://outlook.office365.com/owa/service.svc/s/GetFileAttachment?id='+encodeURIComponent(imgid)+'&X-OWA-CANARY='+getCookie('CANARY'));
		}
		
		return body;
	}

	function removeIMG(text){
		return text.replace(/<img.*?\/>/, '');
	}
	
	function createPDF(){
		var doc = new jsPDF('l', 'px', 'a4');
		doc.fromHTML(removeIMG(document.getElementById("out").innerHTML), 5, 5, { 'width': 590 }, function(){
			doc.save('email.pdf');
		});
	}
	
	function openPDFSoftware(){
		window.print();
	}
	
	function setCookie(cname, cvalue, exdays) {
		var d = new Date();
		d.setTime(d.getTime() + (exdays*24*60*60*1000));
		var expires = "expires="+d.toUTCString();
		document.cookie = cname + "=" + cvalue + "; " + expires;
	}
	
	function getCookie(cname) {
		var name = cname + "=";
		var ca = document.cookie.split(';');
		for(var i=0; i<ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0)==' ') c = c.substring(1);
			if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
		}
		return "";
	}

</script>
<style type="text/css">	
	body{
		padding-top: 20px;
	}
	.PDFtable{
		width:100%;
	}
	.PDFtd{
		text-align:center;
		width:50%;
		font-weight:bold;
		font-family:Verdana, Geneva, sans-serif;
		font-size:14px;
		color:#006;
	}
	.PDFimg{
		width:100px;
		height:30px;
		cursor:pointer;
	}
	
	#out{
		display: none;
	}
	
	@media print {
		.PDFtable{
			display: none;
		}
		#out{
			display: block;
		}
	}
</style>
<body>
<table class="PDFtable">
<tr>
<td id="noIMG" class="PDFtd">Carregando...</td>
<td id="yeIMG" class="PDFtd">Carregando...</td>
</tr>
</table>
<div id="out"></div>
</body>
</html>
